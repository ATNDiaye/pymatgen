<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>pymatgen.io.abinitio.workflows &mdash; pymatgen 3.0.1 documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/proBlue.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '3.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="top" title="pymatgen 3.0.1 documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
 
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-33990148-1']);
  _gaq.push(['_trackPageview']);
</script>

  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pymatgen 3.0.1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for pymatgen.io.abinitio.workflows</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Abinit Workflows</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">filter</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="kn">import</span> <span class="nb">zip</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pydispatch</span> <span class="kn">import</span> <span class="n">dispatcher</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="kn">from</span> <span class="nn">pymatgen.core.units</span> <span class="kn">import</span> <span class="n">ArrayWithUnit</span><span class="p">,</span> <span class="n">Ha_to_eV</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.lattice</span> <span class="kn">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.structure</span> <span class="kn">import</span> <span class="n">Structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.core.design_patterns</span> <span class="kn">import</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">AttrDict</span>
<span class="kn">from</span> <span class="nn">pymatgen.serializers.json_coders</span> <span class="kn">import</span> <span class="n">PMGSONable</span><span class="p">,</span> <span class="n">json_pretty_dump</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.smartio</span> <span class="kn">import</span> <span class="n">read_structure</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.num_utils</span> <span class="kn">import</span> <span class="n">iterator_from_slice</span><span class="p">,</span> <span class="n">chunks</span><span class="p">,</span> <span class="n">monotonic</span>
<span class="kn">from</span> <span class="nn">pymatgen.util.string_utils</span> <span class="kn">import</span> <span class="n">pprint_table</span><span class="p">,</span> <span class="n">WildCard</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio</span> <span class="kn">import</span> <span class="n">wrappers</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.tasks</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Task</span><span class="p">,</span> <span class="n">AbinitTask</span><span class="p">,</span> <span class="n">Dependency</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">ScfTask</span><span class="p">,</span> <span class="n">NscfTask</span><span class="p">,</span> <span class="n">DdkTask</span><span class="p">,</span> <span class="n">BseTask</span><span class="p">,</span> <span class="n">RelaxTask</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.strategies</span> <span class="kn">import</span> <span class="n">HtcStrategy</span><span class="p">,</span> <span class="n">ScfStrategy</span> <span class="c">#, RelaxStrategy</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.utils</span> <span class="kn">import</span> <span class="n">Directory</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.netcdf</span> <span class="kn">import</span> <span class="n">ETSF_Reader</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.abiobjects</span> <span class="kn">import</span> <span class="n">Smearing</span><span class="p">,</span> <span class="n">AbiStructure</span><span class="p">,</span> <span class="n">KSampling</span><span class="p">,</span> <span class="n">Electrons</span>  <span class="c">#, RelaxationMethod</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.pseudos</span> <span class="kn">import</span> <span class="n">Pseudo</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.abitimer</span> <span class="kn">import</span> <span class="n">AbinitTimerParser</span>
<span class="kn">from</span> <span class="nn">pymatgen.io.abinitio.abiinspect</span> <span class="kn">import</span> <span class="n">yaml_read_kpoints</span>


<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s">&quot;Copyright 2013, The Materials Project&quot;</span>
<span class="n">__version__</span> <span class="o">=</span> <span class="s">&quot;0.1&quot;</span>
<span class="n">__maintainer__</span> <span class="o">=</span> <span class="s">&quot;Matteo Giantomassi&quot;</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">&quot;Workflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;BandStructureWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;RelaxWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;G0W0_Workflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;QptdmWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;SigmaConvWorkflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;BSEMDF_Workflow&quot;</span><span class="p">,</span>
    <span class="s">&quot;PhononWorkflow&quot;</span><span class="p">,</span>
<span class="p">]</span>


<span class="k">class</span> <span class="nc">WorkflowResults</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">PMGSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dictionary used to store some of the results produce by a workflow.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_MANDATORY_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;task_results&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">_EXC_KEY</span> <span class="o">=</span> <span class="s">&quot;_exceptions&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WorkflowResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;List of registered exceptions.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exceptions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save a list of exceptions.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="n">newstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">newstr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">assert_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns empty string if results seem valid.</span>

<span class="sd">        The try assert except trick allows one to get a string with info on the exception.</span>
<span class="sd">        We use the += operator so that sub-classes can add their own message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Validate tasks.</span>
        <span class="k">for</span> <span class="n">tres</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">[</span><span class="s">&quot;task_results&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tres</span><span class="o">.</span><span class="n">assert_valid</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">json_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="n">json_pretty_dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_dict</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Convert object to dictionary.&quot;&quot;&quot;</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;@module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;@class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build the object from a dictionary.&quot;&quot;&quot;</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;@module&quot;</span><span class="p">,</span> <span class="s">&quot;@class&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">WorkflowError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for the exceptions raised by Workflow objects.&quot;&quot;&quot;</span>


<span class="k">class</span> <span class="nc">BaseWorkflow</span><span class="p">(</span><span class="n">six</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABCMeta</span><span class="p">,</span> <span class="n">Node</span><span class="p">)):</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">WorkflowError</span>

    <span class="n">Results</span> <span class="o">=</span> <span class="n">WorkflowResults</span>

    <span class="c"># interface modeled after subprocess.Popen</span>
    <span class="nd">@abc.abstractproperty</span>
    <span class="k">def</span> <span class="nf">processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of objects that support the subprocess.Popen protocol.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">poll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if all child processes have terminated. Set and return</span>
<span class="sd">        returncode attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for child processed to terminate. Set and return returncode attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">communicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Interact with processes: Send data to stdin. Read data from stdout and</span>
<span class="sd">        stderr, until end-of-file is reached.</span>
<span class="sd">        Wait for process to terminate. The optional input argument should be a</span>
<span class="sd">        string to be sent to the child processed, or None, if no data should be</span>
<span class="sd">        sent to the children.</span>

<span class="sd">        communicate() returns a list of tuples (stdoutdata, stderrdata).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">show_intrawork_deps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Show the dependencies within the `Workflow`.&quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">[[</span><span class="s">&quot;Task #&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))]]</span>

        <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">task1</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span> <span class="o">*</span> <span class="p">[</span><span class="s">&quot;&quot;</span><span class="p">]</span>
            <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span> <span class="n">task2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">task1</span><span class="o">.</span><span class="n">depends_on</span><span class="p">(</span><span class="n">task2</span><span class="p">):</span>
                    <span class="n">line</span><span class="p">[</span><span class="n">jj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;^&quot;</span>

            <span class="n">table</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

        <span class="n">pprint_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">returncodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The children return codes, set by poll() and wait() (and indirectly by communicate()).</span>
<span class="sd">        A None value indicates that the process hasn&#39;t terminated yet.</span>
<span class="sd">        A negative value -N indicates that the child was terminated by signal N (Unix only).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">returncode</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncpus_reserved</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs reserved in this moment.</span>
<span class="sd">        A CPUS is reserved if it&#39;s still not running but </span>
<span class="sd">        we have submitted the task to the queue manager.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tot_ncpus</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_SUB</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncpus_allocated</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs allocated in this moment.</span>
<span class="sd">        A CPU is allocated if it&#39;s running a task or if we have</span>
<span class="sd">        submitted a task to the queue manager but the job is still pending.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tot_ncpus</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="ow">in</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">S_SUB</span><span class="p">,</span> <span class="n">task</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ncpus_inuse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the number of CPUs used in this moment.</span>
<span class="sd">        A CPU is used if there&#39;s a job that is running on it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">tot_ncpus</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_RUN</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">fetch_task_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the first task that is ready to run or </span>
<span class="sd">        None if no task can be submitted at present&quot;</span>

<span class="sd">        Raises:</span>
<span class="sd">            `StopIteration` if all tasks are done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># All the tasks are done so raise an exception </span>
        <span class="c"># that will be handled by the client code.</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">is_completed</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">StopIteration</span><span class="p">(</span><span class="s">&quot;All tasks completed.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">can_run</span><span class="p">:</span>
                <span class="c">#print(task, str(task.status), [task.deps_status])</span>
                <span class="k">return</span> <span class="n">task</span>

        <span class="c"># No task found, this usually happens when we have dependencies. </span>
        <span class="c"># Beware of possible deadlocks here!</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s">&quot;Possible deadlock in fetch_task_to_run!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">fetch_alltasks_to_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list with all the tasks that can be submitted.</span>
<span class="sd">        Empty list if not task has been found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#if all(task.is_completed for task in self):</span>
        <span class="c">#    return []</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">task</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span> <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">can_run</span><span class="p">]</span>

    <span class="nd">@abc.abstractmethod</span>
    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Method called before submitting the calculations.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">connect_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Connect the signals within the workflow.</span>
<span class="sd">        self is responsible for catching the important signals raised from </span>
<span class="sd">        its task and raise new signals when some particular condition occurs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">dispatcher</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_ok</span><span class="p">,</span> <span class="n">signal</span><span class="o">=</span><span class="n">task</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_OK</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is called when one task reaches status S_OK.</span>
<span class="sd">        It executes on_all_ok when all task in self have reached S_OK.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;in on_ok with sender </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sender</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_ok</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">finalized</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Workflow has been already finalized&quot;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Set finalized here, because on_all_ok might change it (e.g. Relax + EOS in a single workflow)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">on_all_ok</span><span class="p">())</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">raise</span>

                <span class="c"># Signal to possible observers that the `Workflow` reached S_OK</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Workflow </span><span class="si">%s</span><span class="s"> is finalized and broadcasts signal S_OK&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;Workflow </span><span class="si">%s</span><span class="s"> status = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finalized</span><span class="p">:</span>
                    <span class="n">dispatcher</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">signal</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">S_OK</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">results</span>

        <span class="k">return</span> <span class="n">AttrDict</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Not all tasks are OK!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called once the `workflow` is completed i.e. when all the tasks </span>
<span class="sd">        have reached status S_OK. Subclasses should provide their own implementation</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary that must contain at least the following entries:</span>
<span class="sd">                returncode:</span>
<span class="sd">                    0 on success. </span>
<span class="sd">                message: </span>
<span class="sd">                    a string that should provide a human-readable description of what has been performed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;Calling on_all_ok of the base class!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called once the calculations are completed.</span>

<span class="sd">        The base version returns a dictionary task_name: TaskResults for each task in self.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">WorkflowResults</span><span class="p">(</span><span class="n">task_results</span><span class="o">=</span><span class="p">{</span><span class="n">task</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">results</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">})</span>


<div class="viewcode-block" id="Workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow">[docs]</a><span class="k">class</span> <span class="nc">Workflow</span><span class="p">(</span><span class="n">BaseWorkflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Workflow is a list of (possibly connected) tasks.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">Error</span> <span class="o">=</span> <span class="n">WorkflowError</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            workdir:</span>
<span class="sd">                Path to the working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="n">workdir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>

<div class="viewcode-block" id="Workflow.set_manager"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.set_manager">[docs]</a>    <span class="k">def</span> <span class="nf">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the `TaskManager` to use to launch the Task.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">manager</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.flow">[docs]</a>    <span class="k">def</span> <span class="nf">flow</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The flow containing this `Workflow`.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flow</span>
</div>
<div class="viewcode-block" id="Workflow.set_flow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.set_flow">[docs]</a>    <span class="k">def</span> <span class="nf">set_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flow</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the flow associated to this `Workflow`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;_flow&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_flow</span> <span class="o">=</span> <span class="n">flow</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_flow</span> <span class="o">!=</span> <span class="n">flow</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;self._flow != flow&quot;</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.set_workdir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.set_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">set_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the working directory. Cannot be set more than once unless chroot is True&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">chroot</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">!=</span> <span class="n">workdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;self.workdir != workdir: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span>  <span class="n">workdir</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">workdir</span><span class="p">)</span>
                                                                       
        <span class="c"># Directories with (input|output|temporary) data.</span>
        <span class="c"># The workflow will use these directories to connect </span>
        <span class="c"># itself to other workflows and/or to produce new data </span>
        <span class="c"># that will be used by its children.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;indata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;outdata&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;tmpdata&quot;</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Workflow.chroot"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.chroot">[docs]</a>    <span class="k">def</span> <span class="nf">chroot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_workdir</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">new_workdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="n">new_tdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;t&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="n">task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">new_tdir</span><span class="p">,</span> <span class="n">chroot</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</div>
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">__iter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">slice</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="p">[</span><span class="nb">slice</span><span class="p">]</span>

<div class="viewcode-block" id="Workflow.chunks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.chunks">[docs]</a>    <span class="k">def</span> <span class="nf">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield successive chunks of tasks of lenght chunk_size.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tasks</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">tasks</span>
</div>
    <span class="k">def</span> <span class="nf">opath_from_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path of the output file with extension ext.</span>
<span class="sd">        Use it when the file does not exist yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;in_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

<div class="viewcode-block" id="Workflow.opath_from_ext"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.opath_from_ext">[docs]</a>    <span class="k">def</span> <span class="nf">opath_from_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path of the output file with extension ext.</span>
<span class="sd">        Use it when the file does not exist yet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;out_&quot;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.processes"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.processes">[docs]</a>    <span class="k">def</span> <span class="nf">processes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">process</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.all_done"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.all_done">[docs]</a>    <span class="k">def</span> <span class="nf">all_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if all the `Task` in the `Workflow` are done.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">task</span><span class="o">.</span><span class="n">S_DONE</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.isnc"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.isnc">[docs]</a>    <span class="k">def</span> <span class="nf">isnc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if norm-conserving calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">isnc</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.ispaw"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.ispaw">[docs]</a>    <span class="k">def</span> <span class="nf">ispaw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if PAW calculation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">ispaw</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">)</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.status_counter"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.status_counter">[docs]</a>    <span class="k">def</span> <span class="nf">status_counter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a `Counter` object that counts the number of task with </span>
<span class="sd">        given status (use the string representation of the status as key).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">()</span> 

        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">counter</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">status</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">counter</span>
</div>
<div class="viewcode-block" id="Workflow.allocate"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.allocate">[docs]</a>    <span class="k">def</span> <span class="nf">allocate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is called once we have completed the initialization </span>
<span class="sd">        of the `Workflow`. It sets the manager of each task (if not already done)</span>
<span class="sd">        and defines the working directories of the tasks.</span>

<span class="sd">        Args:</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s">&quot;manager&quot;</span><span class="p">):</span>
                <span class="c"># Set the manager</span>
                <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="c"># Use the one provided in input.</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="n">manager</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c"># Use the one of the workflow.</span>
                    <span class="n">task</span><span class="o">.</span><span class="n">set_manager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

            <span class="n">task_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;t&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">):</span>
                <span class="n">task</span><span class="o">.</span><span class="n">set_workdir</span><span class="p">(</span><span class="n">task_workdir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">workdir</span> <span class="o">!=</span> <span class="n">task_workdir</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;task.workdir != task_workdir: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">task_workdir</span><span class="p">))</span>
</div>
<div class="viewcode-block" id="Workflow.register"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">required_files</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Registers a new `Task` and add it to the internal list, taking into account possible dependencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            obj:</span>
<span class="sd">                `Strategy` object or `AbinitInput` instance.</span>
<span class="sd">                if Strategy object, we create a new `AbinitTask` from the input strategy and add it to the list.</span>
<span class="sd">            deps:</span>
<span class="sd">                Dictionary specifying the dependency of this node.</span>
<span class="sd">                None means that this obj has no dependency.</span>
<span class="sd">            required_files:</span>
<span class="sd">                List of strings with the path of the files used by the task.</span>
<span class="sd">                Note that the files must exist when the task is registered.</span>
<span class="sd">                Use the standard approach based on Workflows, Tasks and deps </span>
<span class="sd">                if the files will be produced in the future.</span>
<span class="sd">            manager:</span>
<span class="sd">                The `TaskManager` responsible for the submission of the task. If manager is None, we use </span>
<span class="sd">                the `TaskManager` specified during the creation of the `Workflow`.</span>
<span class="sd">            task_class:</span>
<span class="sd">                Task subclass to instantiate. Default: `AbinitTask` </span>

<span class="sd">        Returns:   </span>
<span class="sd">            `Task` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task_workdir</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;workdir&quot;</span><span class="p">):</span>
            <span class="n">task_workdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="s">&quot;t&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Task</span><span class="p">):</span>
            <span class="n">task</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Set the class</span>
            <span class="k">if</span> <span class="n">task_class</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">task_class</span> <span class="o">=</span> <span class="n">AbinitTask</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HtcStrategy</span><span class="p">):</span>
                <span class="c"># Create the new task (note the factory so that we create subclasses easily).</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">task_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="n">task_class</span><span class="o">.</span><span class="n">from_input</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">task_workdir</span><span class="p">,</span> <span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="c"># Handle possible dependencies.</span>
        <span class="k">if</span> <span class="n">deps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="n">Dependency</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">exts</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="n">task</span><span class="o">.</span><span class="n">add_deps</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span>

        <span class="c"># Handle possible dependencies.</span>
        <span class="k">if</span> <span class="n">required_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">add_required_files</span><span class="p">(</span><span class="n">required_files</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">task</span>

    <span class="c"># Helper functions</span></div>
<div class="viewcode-block" id="Workflow.register_scf_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register_scf_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_scf_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a Scf task.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;task_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ScfTask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                                                    </div>
<div class="viewcode-block" id="Workflow.register_nscf_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register_nscf_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_nscf_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a nscf task.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;task_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">NscfTask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                                                    </div>
<div class="viewcode-block" id="Workflow.register_relax_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register_relax_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_relax_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a task for structural optimization.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;task_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RelaxTask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.register_ddk_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register_ddk_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_ddk_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a nscf task.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;task_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DdkTask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.register_bse_task"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.register_bse_task">[docs]</a>    <span class="k">def</span> <span class="nf">register_bse_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Register a nscf task.&quot;&quot;&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&quot;task_class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BseTask</span>
</div>
<div class="viewcode-block" id="Workflow.path_in_workdir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.path_in_workdir">[docs]</a>    <span class="k">def</span> <span class="nf">path_in_workdir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the absolute path of filename in the working directory.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.setup"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.setup">[docs]</a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method called before running the calculations.</span>
<span class="sd">        The default implementation is empty.</span>
<span class="sd">        &quot;&quot;&quot;</span>
</div>
<div class="viewcode-block" id="Workflow.build"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates the top level directory.&quot;&quot;&quot;</span>
        <span class="c"># Create the directories of the workflow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">makedirs</span><span class="p">()</span>

        <span class="c"># Build dirs and files of each task.</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Connect signals within the workflow.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect_signals</span><span class="p">()</span>
</div>
    <span class="nd">@property</span>
<div class="viewcode-block" id="Workflow.status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.status">[docs]</a>    <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the status of the workflow i.e. the minimum of the status of the tasks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_status</span><span class="p">(</span><span class="n">only_min</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="c">#def set_status(self, status):</span>
</div>
<div class="viewcode-block" id="Workflow.get_all_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.get_all_status">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">only_min</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a list with the status of the tasks in self.</span>

<span class="sd">        Args:</span>
<span class="sd">            only_min:</span>
<span class="sd">                If True, the minimum of the status is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c"># The workflow will be created in the future.</span>
            <span class="k">if</span> <span class="n">only_min</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">S_INIT</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">S_INIT</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>
        <span class="n">status_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">only_min</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">status_list</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">status_list</span>
</div>
<div class="viewcode-block" id="Workflow.check_status"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.check_status">[docs]</a>    <span class="k">def</span> <span class="nf">check_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check the status of the tasks.&quot;&quot;&quot;</span>
        <span class="c"># Recompute the status of the tasks</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">check_status</span><span class="p">()</span>

        <span class="c"># Take into account possible dependencies. Use a list instead of generators </span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c"># todo should this not be &lt; ? a task that is already submitted should not be put to ready</span>
            <span class="c"># it does no harm because of the lock file but logically it seems wrong also gives the wrong infromation</span>
            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">status</span> <span class="o">&lt;=</span> <span class="n">task</span><span class="o">.</span><span class="n">S_SUB</span> <span class="ow">and</span> <span class="nb">all</span><span class="p">([</span><span class="n">status</span> <span class="o">==</span> <span class="n">task</span><span class="o">.</span><span class="n">S_OK</span> <span class="k">for</span> <span class="n">status</span> <span class="ow">in</span> <span class="n">task</span><span class="o">.</span><span class="n">deps_status</span><span class="p">]):</span> 
                <span class="n">task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">S_READY</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.rmtree"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rmtree">[docs]</a>    <span class="k">def</span> <span class="nf">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude_wildcard</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove all files and directories in the working directory</span>

<span class="sd">        Args:</span>
<span class="sd">            exclude_wildcard:</span>
<span class="sd">                Optional string with regular expressions separated by `|`.</span>
<span class="sd">                Files matching one of the regular expressions will be preserved.</span>
<span class="sd">                example: exclude_wildard=&quot;*.nc|*.txt&quot; preserves all the files</span>
<span class="sd">                whose extension is in [&quot;nc&quot;, &quot;txt&quot;].</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">exclude_wildcard</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">WildCard</span><span class="p">(</span><span class="n">exclude_wildcard</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">dirpath</span><span class="p">,</span> <span class="n">dirnames</span><span class="p">,</span> <span class="n">filenames</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dirpath</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">w</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.rm_indatadir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rm_indatadir">[docs]</a>    <span class="k">def</span> <span class="nf">rm_indatadir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the indata directories.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">rm_indatadir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.rm_outdatadir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rm_outdatadir">[docs]</a>    <span class="k">def</span> <span class="nf">rm_outdatadir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the indata directories.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">rm_outatadir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.rm_tmpdatadir"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.rm_tmpdatadir">[docs]</a>    <span class="k">def</span> <span class="nf">rm_tmpdatadir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all the tmpdata directories.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">rm_tmpdatadir</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.move"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.move">[docs]</a>    <span class="k">def</span> <span class="nf">move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">isabspath</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Recursively move self.workdir to another location. This is similar to the Unix &quot;mv&quot; command.</span>
<span class="sd">        The destination path must not already exist. If the destination already exists</span>
<span class="sd">        but is not a directory, it may be overwritten depending on os.rename() semantics.</span>

<span class="sd">        Be default, dest is located in the parent directory of self.workdir, use isabspath=True</span>
<span class="sd">        to specify an absolute path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isabspath</span><span class="p">:</span>
            <span class="n">dest</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">),</span> <span class="n">dest</span><span class="p">)</span>

        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workdir</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.submit_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.submit_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">submit_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Submits the task in self and wait.</span>
<span class="sd">        TODO: change name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">task</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">wait</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span> <span class="n">task</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="Workflow.start"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start the work. Calls build and _setup first, then submit the tasks.</span>
<span class="sd">        Non-blocking call unless wait is set to True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wait</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&quot;wait&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="c"># Initial setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_setup</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Build dirs and files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># Submit tasks (does not block)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit_tasks</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.read_etotals"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.read_etotals">[docs]</a>    <span class="k">def</span> <span class="nf">read_etotals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s">&quot;Ha&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads the total energy from the GSR file produced by the task.</span>

<span class="sd">        Return a numpy array with the total energies in Hartree</span>
<span class="sd">        The array element is set to np.inf if an exception is raised while reading the GSR file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_done</span><span class="p">:</span>
            <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span><span class="s">&quot;Some task is still in running/submitted state&quot;</span><span class="p">)</span>

        <span class="n">etotals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c"># Open the GSR file and read etotal (Hartree)</span>
            <span class="n">gsr_path</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;GSR&quot;</span><span class="p">)</span>
            <span class="n">etot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">if</span> <span class="n">gsr_path</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">ETSF_Reader</span><span class="p">(</span><span class="n">gsr_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">r</span><span class="p">:</span>
                    <span class="n">etot</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">read_value</span><span class="p">(</span><span class="s">&quot;etotal&quot;</span><span class="p">)</span>
                
            <span class="n">etotals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">etot</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ArrayWithUnit</span><span class="p">(</span><span class="n">etotals</span><span class="p">,</span> <span class="s">&quot;Ha&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">unit</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="Workflow.parse_timers"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.Workflow.parse_timers">[docs]</a>    <span class="k">def</span> <span class="nf">parse_timers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse the TIMER section reported in the ABINIT output files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            `AbinitTimerParser` object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filenames</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">output_file</span><span class="o">.</span><span class="n">path</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>
                                                                           
        <span class="n">parser</span> <span class="o">=</span> <span class="n">AbinitTimerParser</span><span class="p">()</span>
        <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>
                                                                           
        <span class="k">return</span> <span class="n">parser</span>

</div></div>
<div class="viewcode-block" id="BandStructureWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.BandStructureWorkflow">[docs]</a><span class="k">class</span> <span class="nc">BandStructureWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Workflow for band structure calculations.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">dos_inputs</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_input:</span>
<span class="sd">                Input for the SCF run or `SCFStrategy` object.</span>
<span class="sd">            nscf_input:</span>
<span class="sd">                Input for the NSCF run or `NSCFStrategy` object defining the band structure calculation.</span>
<span class="sd">            dos_inputs:</span>
<span class="sd">                Input(s) for the DOS. DOS is computed only if dos_inputs is not None.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BandStructureWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the GS-SCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

        <span class="c"># Register the NSCF run and its dependency.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

        <span class="c"># Add DOS computation(s) if requested.</span>
        <span class="k">if</span> <span class="n">dos_inputs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dos_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="n">dos_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">dos_inputs</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">dos_input</span> <span class="ow">in</span> <span class="n">dos_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">dos_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="RelaxWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.RelaxWorkflow">[docs]</a><span class="k">class</span> <span class="nc">RelaxWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Workflow for structural relaxations. The first task relaxes the atomic position</span>
<span class="sd">    while keeping the unit cell parameters fixed. The second task uses the final </span>
<span class="sd">    structure to perform a structural relaxation in which both the atomic positions</span>
<span class="sd">    and the lattice parameters are optimized.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ion_input</span><span class="p">,</span> <span class="n">ioncell_input</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            ion_input:</span>
<span class="sd">                Input for the relaxation of the ions (cell is fixed)</span>
<span class="sd">            ioncell_input:</span>
<span class="sd">                Input for the relaxation of the ions and the unit cell.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RelaxWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ion_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">RelaxTask</span><span class="p">)</span>

        <span class="c"># Use WFK for the time being since I don&#39;t know why Abinit produces all these _TIM?_DEN files.</span>
        <span class="c">#self.ioncell_task = self.register(ioncell_input, deps={self.ion_task: &quot;DEN&quot;}, task_class=RelaxTask)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">ioncell_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">RelaxTask</span><span class="p">)</span>

        <span class="c"># Lock ioncell_task as ion_task should communicate to ioncell_task that </span>
        <span class="c"># the calculation is OK and pass the final structure.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_LOCKED</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="bp">False</span>

<div class="viewcode-block" id="RelaxWorkflow.on_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.RelaxWorkflow.on_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sender</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This callback is called when one task reaches status S_OK.</span>
<span class="sd">        If sender == self.ion_task, we update the initial structure</span>
<span class="sd">        used by self.ioncell_task and we unlock it so that the job can be submitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;in on_ok with sender </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sender</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sender</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span><span class="p">:</span>
            <span class="c"># Get the relaxed structure from ion_task</span>
            <span class="n">ion_structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ion_task</span><span class="o">.</span><span class="n">read_final_structure</span><span class="p">()</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Got relaxed ion_structure&quot;</span><span class="p">,</span> <span class="n">ion_structure</span><span class="p">)</span>

            <span class="c"># Transfer it to the ioncell task (we do it only once).</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span><span class="o">.</span><span class="n">change_structure</span><span class="p">(</span><span class="n">ion_structure</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transfer_done</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="c"># Unlock ioncell_task so that we can submit it.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ioncell_task</span><span class="o">.</span><span class="n">set_status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S_READY</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">RelaxWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">on_ok</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="G0W0_Workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.G0W0_Workflow">[docs]</a><span class="k">class</span> <span class="nc">G0W0_Workflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Workflow for G0W0 calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span>
                 <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_input:</span>
<span class="sd">                Input for the SCF run or `SCFStrategy` object.</span>
<span class="sd">            nscf_input:</span>
<span class="sd">                Input for the NSCF run or `NSCFStrategy` object.</span>
<span class="sd">            scr_input:</span>
<span class="sd">                Input for the screening run or `ScrStrategy` object </span>
<span class="sd">            sigma_inputs:</span>
<span class="sd">                List of Strategies for the self-energy run.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory of the calculation.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">G0W0_Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the GS-SCF run.</span>
        <span class="c"># register all scf_inputs but link the nscf only the last scf in the list</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">single_scf_input</span> <span class="ow">in</span> <span class="n">scf_input</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">single_scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

        <span class="c"># Construct the input for the NSCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span> <span class="o">=</span> <span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

        <span class="c"># Register the SCREENING run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scr_task</span> <span class="o">=</span> <span class="n">scr_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scr_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">})</span>

        <span class="c"># Register the SIGMA runs.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> 
            <span class="n">sigma_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma_inputs</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sigma_tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sigma_input</span> <span class="ow">in</span> <span class="n">sigma_inputs</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sigma_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">scr_task</span><span class="p">:</span> <span class="s">&quot;SCR&quot;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="SigmaConvWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.SigmaConvWorkflow">[docs]</a><span class="k">class</span> <span class="nc">SigmaConvWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Workflow for self-energy convergence studies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wfk_node</span><span class="p">,</span> <span class="n">scr_node</span><span class="p">,</span> <span class="n">sigma_inputs</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            wfk_node:</span>
<span class="sd">                The node who has produced the WFK file or filepath pointing to the WFK file.</span>
<span class="sd">            scr_node:</span>
<span class="sd">                The node who has produced the SCR file or filepath pointing to the SCR file.</span>
<span class="sd">            sigma_inputs:</span>
<span class="sd">                List of Strategies for the self-energy run.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory of the calculation.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Cast to node instances.</span>
        <span class="n">wfk_node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">as_node</span><span class="p">(</span><span class="n">wfk_node</span><span class="p">)</span>
        <span class="n">scr_node</span> <span class="o">=</span> <span class="n">Node</span><span class="o">.</span><span class="n">as_node</span><span class="p">(</span><span class="n">scr_node</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">SigmaConvWorkflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the SIGMA runs.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sigma_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span> 
            <span class="n">sigma_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">sigma_inputs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">sigma_input</span> <span class="ow">in</span> <span class="n">sigma_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">sigma_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="n">wfk_node</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">,</span> <span class="n">scr_node</span><span class="p">:</span> <span class="s">&quot;SCR&quot;</span><span class="p">})</span>

</div>
<div class="viewcode-block" id="BSEMDF_Workflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.BSEMDF_Workflow">[docs]</a><span class="k">class</span> <span class="nc">BSEMDF_Workflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Workflow for simple BSE calculations in which the self-energy corrections</span>
<span class="sd">    are approximated by the scissors operator and the screening in modeled</span>
<span class="sd">    with the model dielectric function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scf_input</span><span class="p">,</span> <span class="n">nscf_input</span><span class="p">,</span> <span class="n">bse_inputs</span><span class="p">,</span> <span class="n">workdir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            scf_input:</span>
<span class="sd">                Input for the SCF run or `ScfStrategy` object.</span>
<span class="sd">            nscf_input:</span>
<span class="sd">                Input for the NSCF run or `NscfStrategy` object.</span>
<span class="sd">            bse_inputs:</span>
<span class="sd">                List of Inputs for the BSE run or `BSEStrategy` object.</span>
<span class="sd">            workdir:</span>
<span class="sd">                Working directory of the calculation.</span>
<span class="sd">            manager:</span>
<span class="sd">                `TaskManager`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BSEMDF_Workflow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="n">workdir</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="n">manager</span><span class="p">)</span>

        <span class="c"># Register the GS-SCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">scf_input</span><span class="p">,</span> <span class="n">task_class</span><span class="o">=</span><span class="n">ScfTask</span><span class="p">)</span>

        <span class="c"># Construct the input for the NSCF run.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">nscf_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scf_task</span><span class="p">:</span> <span class="s">&quot;DEN&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">NscfTask</span><span class="p">)</span>

        <span class="c"># Construct the input(s) for the BSE run.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bse_inputs</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
            <span class="n">bse_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bse_inputs</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">bse_input</span> <span class="ow">in</span> <span class="n">bse_inputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">bse_input</span><span class="p">,</span> <span class="n">deps</span><span class="o">=</span><span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nscf_task</span><span class="p">:</span> <span class="s">&quot;WFK&quot;</span><span class="p">},</span> <span class="n">task_class</span><span class="o">=</span><span class="n">BseTask</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="QptdmWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.QptdmWorkflow">[docs]</a><span class="k">class</span> <span class="nc">QptdmWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This workflow parallelizes the calculation of the q-points of the screening.</span>
<span class="sd">    It also provides the callback `on_all_ok` that calls mrgscr to merge</span>
<span class="sd">    all the partial screening files produced.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="QptdmWorkflow.create_tasks"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.QptdmWorkflow.create_tasks">[docs]</a>    <span class="k">def</span> <span class="nf">create_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wfk_file</span><span class="p">,</span> <span class="n">scr_input</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the SCR tasks and register them in self.</span>

<span class="sd">        Args:</span>
<span class="sd">            wfk_file:</span>
<span class="sd">                Path to the ABINIT WFK file to use for the computation of the screening.</span>
<span class="sd">            scr_input:</span>
<span class="sd">                Input for the screening calculation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">wfk_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wfk_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">wfk_file</span><span class="p">)</span>

        <span class="c"># Build a temporary workflow in the tmpdir that will use a shell manager</span>
        <span class="c"># to run ABINIT in order to get the list of q-points for the screening.</span>
        <span class="n">shell_manager</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="o">.</span><span class="n">to_shell_manager</span><span class="p">(</span><span class="n">mpi_ncpus</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">w</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">workdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="o">.</span><span class="n">path_join</span><span class="p">(</span><span class="s">&quot;_qptdm_run&quot;</span><span class="p">),</span> <span class="n">manager</span><span class="o">=</span><span class="n">shell_manager</span><span class="p">)</span>

        <span class="n">fake_input</span> <span class="o">=</span> <span class="n">scr_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
        <span class="n">fake_task</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">fake_input</span><span class="p">)</span>
        <span class="n">w</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
        <span class="n">w</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>

        <span class="c"># Create the symbolic link and add the magic value</span>
        <span class="c"># nqpdm = -1 to the input to get the list of q-points.</span>
        <span class="n">fake_task</span><span class="o">.</span><span class="n">inlink_file</span><span class="p">(</span><span class="n">wfk_file</span><span class="p">)</span>
        <span class="n">fake_task</span><span class="o">.</span><span class="n">strategy</span><span class="o">.</span><span class="n">add_extra_abivars</span><span class="p">({</span><span class="s">&quot;nqptdm&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
        <span class="n">fake_task</span><span class="o">.</span><span class="n">start_and_wait</span><span class="p">()</span>

        <span class="c"># Parse the section with the q-points</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">qpoints</span> <span class="o">=</span> <span class="n">yaml_read_kpoints</span><span class="p">(</span><span class="n">fake_task</span><span class="o">.</span><span class="n">log_file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">doc_tag</span><span class="o">=</span><span class="s">&quot;!Qptdms&quot;</span><span class="p">)</span>
            <span class="c">#print(qpoints)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">w</span><span class="o">.</span><span class="n">rmtree</span><span class="p">()</span>

        <span class="c"># Now we can register the task for the different q-points</span>
        <span class="k">for</span> <span class="n">qpoint</span> <span class="ow">in</span> <span class="n">qpoints</span><span class="p">:</span>
            <span class="n">qptdm_input</span> <span class="o">=</span> <span class="n">scr_input</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="n">qptdm_input</span><span class="o">.</span><span class="n">set_variables</span><span class="p">(</span><span class="n">nqptdm</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">qptdm</span><span class="o">=</span><span class="n">qpoint</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">qptdm_input</span><span class="p">,</span> <span class="n">manager</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">manager</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">allocate</span><span class="p">()</span>
</div>
<div class="viewcode-block" id="QptdmWorkflow.merge_scrfiles"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.QptdmWorkflow.merge_scrfiles">[docs]</a>    <span class="k">def</span> <span class="nf">merge_scrfiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_scrfiles</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        It runs `mrgscr` in sequential on the local machine to produce</span>
<span class="sd">        the final SCR file in the outdir of the `Workflow`.</span>
<span class="sd">        If remove_scrfiles is True, the partial SCR files are removed after the merge.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scr_files</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;SCR&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;will call mrgscr to merge </span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">scr_files</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">scr_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># TODO: Propapagate the manager to the wrappers</span>
        <span class="n">mrgscr</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">Mrgscr</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mrgscr</span><span class="o">.</span><span class="n">set_mpi_runner</span><span class="p">(</span><span class="s">&quot;mpirun&quot;</span><span class="p">)</span>
        <span class="n">final_scr</span> <span class="o">=</span> <span class="n">mrgscr</span><span class="o">.</span><span class="n">merge_qpoints</span><span class="p">(</span><span class="n">scr_files</span><span class="p">,</span> <span class="n">out_prefix</span><span class="o">=</span><span class="s">&quot;out&quot;</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">remove_scrfiles</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">scr_file</span> <span class="ow">in</span> <span class="n">scr_files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">scr_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">return</span> <span class="n">final_scr</span>
</div>
<div class="viewcode-block" id="QptdmWorkflow.on_all_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.QptdmWorkflow.on_all_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        It runs `mrgscr` in sequential on the local machine to produce</span>
<span class="sd">        the final SCR file in the outdir of the `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">final_scr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">merge_scrfiles</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">WorkflowResults</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;mrgscr done&quot;</span><span class="p">,</span> <span class="n">final_scr</span><span class="o">=</span><span class="n">final_scr</span><span class="p">)</span>

</div></div>
<div class="viewcode-block" id="PhononWorkflow"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow">[docs]</a><span class="k">class</span> <span class="nc">PhononWorkflow</span><span class="p">(</span><span class="n">Workflow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This workflow usually consists of nirred Phonon tasks where nirred is </span>
<span class="sd">    the number of irreducible perturbations for a given q-point.</span>
<span class="sd">    It provides the callback method (on_all_ok) that calls mrgddb to merge </span>
<span class="sd">    the partial DDB files and mrgggkk to merge the GKK files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PhononWorkflow.merge_ddb_files"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow.merge_ddb_files">[docs]</a>    <span class="k">def</span> <span class="nf">merge_ddb_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        It runs `mrgddb` in sequential on the local machine to produce</span>
<span class="sd">        the final DDB file in the outdir of the `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ddb_files</span> <span class="o">=</span> <span class="nb">filter</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="p">[</span><span class="n">task</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">has_abiext</span><span class="p">(</span><span class="s">&quot;DDB&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">task</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">])</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s">&quot;will call mrgddb to merge </span><span class="si">%s</span><span class="s">:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c">#if len(ddb_files) == 1:</span>
        <span class="c"># Avoid the merge. Just move the DDB file to the outdir of the workflow</span>

        <span class="c"># Final DDB file will be produced in the outdir of the workflow.</span>
        <span class="n">out_ddb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path_in</span><span class="p">(</span><span class="s">&quot;out_DDB&quot;</span><span class="p">)</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;DDB file merged by </span><span class="si">%s</span><span class="s"> on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">asctime</span><span class="p">())</span>

        <span class="c"># TODO: propagate the taskmanager</span>
        <span class="n">mrgddb</span> <span class="o">=</span> <span class="n">wrappers</span><span class="o">.</span><span class="n">Mrgddb</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mrgddb</span><span class="o">.</span><span class="n">set_mpi_runner</span><span class="p">(</span><span class="s">&quot;mpirun&quot;</span><span class="p">)</span>
        <span class="n">mrgddb</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ddb_files</span><span class="p">,</span> <span class="n">out_ddb</span><span class="o">=</span><span class="n">out_ddb</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="PhononWorkflow.on_all_ok"><a class="viewcode-back" href="../../../../pymatgen.io.abinitio.html#pymatgen.io.abinitio.workflows.PhononWorkflow.on_all_ok">[docs]</a>    <span class="k">def</span> <span class="nf">on_all_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method is called when all the q-points have been computed.</span>
<span class="sd">        Ir runs `mrgddb` in sequential on the local machine to produce</span>
<span class="sd">        the final DDB file in the outdir of the `Workflow`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Merge DDB files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merge_ddb_files</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">WorkflowResults</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s">&quot;DDB merge done&quot;</span><span class="p">)</span>

</div></div>
<span class="k">class</span> <span class="nc">WorkflowResults</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">PMGSONable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dictionary used to store some of the results produce by a Task object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_MANDATORY_KEYS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;task_results&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">_EXC_KEY</span> <span class="o">=</span> <span class="s">&quot;_exceptions&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">WorkflowResults</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">push_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">exceptions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>
            <span class="n">newstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newstr</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">+=</span> <span class="p">[</span><span class="n">newstr</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">assert_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns empty string if results seem valid.</span>

<span class="sd">        The try assert except trick allows one to get a string with info on the exception.</span>
<span class="sd">        We use the += operator so that sub-classes can add their own message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># Validate tasks.</span>
        <span class="k">for</span> <span class="n">tres</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">task_results</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tres</span><span class="o">.</span><span class="n">assert_valid</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_EXC_KEY</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">as_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;@module&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__module__</span>
        <span class="n">d</span><span class="p">[</span><span class="s">&quot;@class&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
        <span class="n">mydict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&quot;@module&quot;</span><span class="p">,</span> <span class="s">&quot;@class&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">cls</span><span class="p">(</span><span class="n">mydict</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../../../index.html">pymatgen 3.0.1 documentation</a> &raquo;</li>
          <li><a href="../../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>

    <div class="footer">
        &copy; Copyright 2011, Shyue Ping Ong, Anubhav Jain, Geoffroy Hautier, William Davidson Richard, Stephen Dacek, Sai Jayaraman, Michael Kocher, Dan Gunter, Shreyas Cholia, Vincent L Chevrier, Rickard Armiento.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.3.
    </div>
<div class="footer">This page uses <a href="http://analytics.google.com/">
Google Analytics</a> to collect statistics. You can disable it by blocking
the JavaScript coming from www.google-analytics.com.
<script type="text/javascript">
  (function() {
    var ga = document.createElement('script');
    ga.src = ('https:' == document.location.protocol ?
              'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    ga.setAttribute('async', 'true');
    document.documentElement.firstChild.appendChild(ga);
  })();
</script>
</div>

  </body>
</html>